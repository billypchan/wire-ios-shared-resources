parameters:
  branch: "develop"

steps:
- script: |
    git clone --single-branch -b $BRANCH https://github.com/wireapp/wire-ios-shared-resources.git
    git clone "https://${GITHUB_ACCESS_TOKEN}@github.com/wireapp/wire-ios-build-assets.git"
    mkdir -p fastlane
    cp wire-ios-shared-resources/Azure/build-ipa/Fastfile fastlane/Fastfile
  env:
    GITHUB_ACCESS_TOKEN: $(GITHUB_ACCESS_TOKEN)   
    BRANCH: ${{ parameters.branch }}
  displayName: "Prepare build scripts"

- script: |
    sudo xcode-select -switch /Applications/Xcode_10.app
    fastlane prepare 
  env:
    GITHUB_ACCESS_TOKEN: $(GITHUB_ACCESS_TOKEN)   
    AVS_REPO: "wireapp/avs-ios-binaries-appstore"
  displayName: "Setup environment"

- script: |
    fastlane release
  displayName: "Build"

- task: PublishBuildArtifacts@1
  inputs:
    artifactName: "App .ipa"
  condition: succeededOrFailed()
  displayName: "Store .ipa"
